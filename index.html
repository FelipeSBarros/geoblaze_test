<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <style>
      #map {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }

    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/georaster"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
<script src="https://unpkg.com/geoblaze"></script>
<script src="https://unpkg.com/chroma-js"></script>
<script>
    // initalize leaflet map
    var map = L.map('map');

    // add OpenStreetMap basemap
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      var url_to_geotiff_file = "https://felipesbarros.github.io/geoblaze_test/pm25_Jul.tif";
      var url_to_acre_geojson = "https://nominatim.openstreetmap.org/search.php?state=Acre&country=Brazil&polygon_geojson=1&format=json";

      fetch(url_to_geotiff_file)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
          parseGeoraster(arrayBuffer).then(
<!--            georaster => {-->
<!--            console.log("georaster:", georaster);-->
            georaster => {
            const min = georaster.mins[0];
            const max = georaster.maxs[0];
            const range = georaster.ranges[0];

            // available color scales can be found by running console.log(chroma.brewer);
<!--            console.log(chroma.brewer);-->
            var scale = chroma.scale("Viridis");
            var layer = new GeoRasterLayer({
                georaster: georaster,
                opacity: 0.7,
                pixelValuesToColorFn: function(pixelValues) {
                  var pixelValue = pixelValues[0]; // there's just one band in this raster

                  // if there's zero wind, don't return a color
                  if (pixelValue === 0) return null;

                  // scale to 0 - 1 used by chroma
                  var scaledPixelValue = (pixelValue - min) / range;

                  var color = scale(scaledPixelValue).hex();

                  return color;
                }
                }).addTo(map)
            map.fitBounds(layer.getBounds());

      fetch(url_to_acre_geojson)
        .then(response => response.json())
        .then(data => {
            console.log("Acre:", data[0].geojson);
            var acreLayer = new L.geoJSON(
              data[0].geojson).addTo(map);

            map.on('click', function(evt) {
              var latlng = map.mouseEventToLatLng(evt.originalEvent);
              alert("Valor de PM<2.5 = " + geoblaze.identify(georaster, [latlng.lng, latlng.lat]));
            });
            });
        });
      });


</script>
</body>
</html>